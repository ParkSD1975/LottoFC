<!DOCTYPE html>
<html class="light" lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Lotto Lab - 합성수 (Supabase AI)</title>
    <link as="style" crossorigin="" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="js/layout.js"></script>

    <script>
        // ✅ Supabase 설정
        const SUPABASE_URL = 'https://dkcflmyoscudawleglzb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrY2ZsbXlvc2N1ZGF3bGVnbHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDQ4OTAsImV4cCI6MjA4MzEyMDg5MH0.haAvbpScvMJv1uqH_tk-0fUlJNCpHnlWBtYzX6YFweo';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 합성수 정의 (1~45 사이)
        const composites = new Set([
            4, 6, 8, 9, 10, 12, 14, 15, 16, 18, 
            20, 21, 22, 24, 25, 26, 27, 28, 30, 32, 
            33, 34, 35, 36, 38, 39, 40, 42, 44, 45
        ]);

        // 소수 정의 (참고용, 1~45 사이)
        const primes = new Set([
            2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43
        ]);

        let allDrawData = []; 
        let compositeChart = null;
        let chartMode = 'distribution'; 
        let currentRange = 100;
        
        // 필터 상태 (버튼 UI 및 통계 카드 연동용)
        let activeFilters = new Set(); 
        let excludedComposites = new Set();

        // 합성수 판별 함수
        function isComposite(num) {
            return composites.has(num);
        }
        
        // 소수 판별 함수
        function isPrime(num) {
            return primes.has(num);
        }

        const minMaxLabelsPlugin = {
            id: 'minMaxLabels',
            afterDatasetsDraw: function(chart) {}
        };

        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: { 
                    colors: { 
                        "active-green": "#E6FFED", 
                        "active-text": "#16A34A", 
                        "lotto-blue": "#3B82F6" 
                    }, 
                    fontFamily: { 
                        "sans": ["Pretendard", "Inter", "sans-serif"] 
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        
        .ball-composite { 
            background: #10B981; color: #FFFFFF; border: 1px solid #059669; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-family: 'Pretendard', sans-serif; font-weight: 600;
        }
        .ball-normal { 
            background: #FFFFFF; color: #1F2937; border: 1px solid #D1D5DB; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-family: 'Pretendard', sans-serif; font-weight: 600;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* 슬라이더 색상 복원 (블루) */
        input[type="range"] { 
            -webkit-appearance: none; appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #E5E7EB; outline: none; cursor: pointer; 
            background-image: linear-gradient(#3B82F6, #3B82F6); background-size: var(--value-percent, 0%) 100%; background-repeat: no-repeat; 
        }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #3B82F6; cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.1s; border: 2px solid white; 
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); background: #2563EB; }
        
        .ai-section { background: linear-gradient(135deg, #E0E7FF 0%, #EDE9FE 50%, #FCE7F3 100%); }
        
        /* 필터 버튼 활성 상태 (블루) */
        .filter-btn-active {
            background-color: #3B82F6 !important;
            color: white !important;
            border-color: #3B82F6 !important;
        }

        /* 통계 카드 활성 상태 (블루) */
        .stat-card-active {
            background-color: #3B82F6 !important;
            border-color: #3B82F6 !important;
        }
        .stat-card-active .stat-label { color: #DBEAFE !important; }
        .stat-card-active .stat-value { color: #FFFFFF !important; }
        
        @keyframes highlightFade {
            0% { background-color: #FEF3C7; transform: scale(1.01); }
            100% { background-color: #FEF3C7; transform: scale(1); }
        }
        .row-highlight {
            animation: highlightFade 0.3s ease-out forwards;
            border-left: 4px solid #F59E0B;
        }
    </style>
</head>
<body class="bg-[#F9FAFB] font-sans antialiased">
    <div class="flex flex-col h-screen w-full">
        <div id="gnb-container"></div>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-56 bg-white border-r border-gray-200 overflow-y-auto custom-scrollbar flex-shrink-0" id="lnb-container">
            </aside>

            <main class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                <div class="max-w-7xl mx-auto space-y-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 mb-1">합성수 분석</h1>
                        <p class="text-sm text-gray-600">합성수 30개(4, 6, 8, 9, 10...)의 출현 개수를 분석합니다.</p>
                    </div>

                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                        <div class="grid grid-cols-7 gap-3 mb-6">
                            <div id="card-0" onclick="toggleSelection(0)" class="cursor-pointer bg-white rounded-xl p-3 border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all text-center">
                                <div class="stat-label text-xs font-semibold text-gray-500 mb-1">0개</div>
                                <p id="count_0" class="stat-value text-lg font-bold text-gray-900">0.0%</p>
                            </div>
                            <div id="card-1" onclick="toggleSelection(1)" class="cursor-pointer bg-white rounded-xl p-3 border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all text-center">
                                <div class="stat-label text-xs font-semibold text-gray-500 mb-1">1개</div>
                                <p id="count_1" class="stat-value text-lg font-bold text-gray-900">0.0%</p>
                            </div>
                            <div id="card-2" onclick="toggleSelection(2)" class="cursor-pointer bg-white rounded-xl p-3 border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all text-center">
                                <div class="stat-label text-xs font-semibold text-gray-500 mb-1">2개</div>
                                <p id="count_2" class="stat-value text-lg font-bold text-gray-900">0.0%</p>
                            </div>
                            <div id="card-3" onclick="toggleSelection(3)" class="cursor-pointer bg-white rounded-xl p-3 border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all text-center">
                                <div class="stat-label text-xs font-semibold text-gray-500 mb-1">3개</div>
                                <p id="count_3" class="stat-value text-lg font-bold text-gray-900">0.0%</p>
                            </div>
                            <div id="card-4" onclick="toggleSelection(4)" class="cursor-pointer bg-white rounded-xl p-3 border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all text-center">
                                <div class="stat-label text-xs font-semibold text-gray-500 mb-1">4개</div>
                                <p id="count_4" class="stat-value text-lg font-bold text-gray-900">0.0%</p>
                            </div>
                            <div id="card-5" onclick="toggleSelection(5)" class="cursor-pointer bg-white rounded-xl p-3 border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all text-center">
                                <div class="stat-label text-xs font-semibold text-gray-500 mb-1">5개</div>
                                <p id="count_5" class="stat-value text-lg font-bold text-gray-900">0.0%</p>
                            </div>
                            <div id="card-6" onclick="toggleSelection(6)" class="cursor-pointer bg-white rounded-xl p-3 border border-gray-200 relative overflow-hidden group hover:shadow-md transition-all text-center">
                                <div class="stat-label text-xs font-semibold text-gray-500 mb-1">6개</div>
                                <p id="count_6" class="stat-value text-lg font-bold text-gray-900">0.0%</p>
                            </div>
                        </div>

                        <div class="ai-section rounded-2xl p-6 mb-6">
                            <div class="flex items-center justify-between mb-5">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-purple-600">psychology</span>
                                    <h3 class="text-lg font-bold text-gray-900">AI 합성수 심층 분석</h3>
                                </div>
                                <button onclick="refreshAIAnalysis()" class="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700">
                                    <span class="material-symbols-outlined text-lg">refresh</span>분석 새로고침
                                </button>
                            </div>
                            <div id="aiAnalysisContent" class="text-sm text-gray-700 leading-relaxed text-left">
                                <div class="flex items-center gap-2 text-gray-500">
                                    <span class="material-symbols-outlined text-lg animate-spin">progress_activity</span>
                                    <span>AI가 종합적인 데이터를 분석하고 있습니다...</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-900">그래프</h3>
                                <div class="flex gap-2">
                                    <button id="chartTypeDistribution" onclick="changeChartMode('distribution')" class="px-4 py-2 text-sm font-medium bg-blue-500 text-white rounded-lg transition-colors">당첨율</button>
                                    <button id="chartTypeRound" onclick="changeChartMode('round')" class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-lg transition-colors">회차기준</button>
                                </div>
                            </div>
                            <div class="h-80"><canvas id="compositeChart"></canvas></div>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-900">분석 회차 범위</h3>
                                <div class="flex items-center gap-2">
                                    <button onclick="setRange(50)" id="preset50" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">50회</button>
                                    <button onclick="setRange(100)" id="preset100" class="px-3 py-1.5 text-sm font-medium bg-blue-500 text-white rounded-lg transition-colors">100회</button>
                                    <button onclick="setRange(500)" id="preset500" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">500회</button>
                                    <button onclick="setRange(1203)" id="preset1203" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">전체</button>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <input type="range" id="rangeSlider" min="10" max="1203" value="100" oninput="updateRange(this.value)"/>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">최근 <span id="rangeDisplay" class="font-bold text-blue-600">100</span>회 분석 대상</span>
                                    <span id="totalRangeDisplay" class="text-gray-500">최대 1,203회</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900">필터</h3>
                            <a href="#filter-page" class="flex items-center gap-1 text-xs font-medium text-gray-500 hover:text-gray-800 transition-colors">
                                <span class="material-symbols-outlined text-sm">open_in_new</span>필터 페이지 가기
                            </a>
                        </div>
                        
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-2">제외수 (통계에서 선택한 합성수)</label>
                            <input 
                                type="text" 
                                id="excludeNumbersInput" 
                                readonly 
                                placeholder="통계 창에서 체크박스를 선택하세요" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 text-sm focus:outline-none"
                            />
                            <p class="text-xs text-gray-500 mt-1">통계 창의 체크박스로 제외할 합성수를 선택하면 여기에 표시됩니다 (리스트 필터링 기능은 제거됨).</p>
                        </div>

                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-6 justify-between">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs text-gray-500 mr-2">합성수 개수 선택:</span>
                                <button onclick="toggleSelection(0)" id="filter-btn-0" class="w-9 h-9 rounded-full border border-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center hover:bg-gray-100 transition-all">0</button>
                                <button onclick="toggleSelection(1)" id="filter-btn-1" class="w-9 h-9 rounded-full border border-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center hover:bg-gray-100 transition-all">1</button>
                                <button onclick="toggleSelection(2)" id="filter-btn-2" class="w-9 h-9 rounded-full border border-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center hover:bg-gray-100 transition-all">2</button>
                                <button onclick="toggleSelection(3)" id="filter-btn-3" class="w-9 h-9 rounded-full border border-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center hover:bg-gray-100 transition-all">3</button>
                                <button onclick="toggleSelection(4)" id="filter-btn-4" class="w-9 h-9 rounded-full border border-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center hover:bg-gray-100 transition-all">4</button>
                                <button onclick="toggleSelection(5)" id="filter-btn-5" class="w-9 h-9 rounded-full border border-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center hover:bg-gray-100 transition-all">5</button>
                                <button onclick="toggleSelection(6)" id="filter-btn-6" class="w-9 h-9 rounded-full border border-gray-300 text-gray-600 text-sm font-bold flex items-center justify-center hover:bg-gray-100 transition-all">6</button>
                            </div>

                            <div class="flex items-center gap-3 ml-auto">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="applyFilterCheck" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                </label>
                                <label for="applyFilterCheck" class="text-sm font-medium text-gray-700 cursor-pointer">필터 적용</label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 mb-1">회차별 당첨번호 및 합성수</h3>
                                <p class="text-sm text-gray-600">
                                    최근 <span id="displayedCount" class="font-bold text-blue-600">100</span>회차 표시
                                </p>
                            </div>
                            <button onclick="openStatsModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors">
                                <span class="material-symbols-outlined text-lg">bar_chart</span>통계 보기
                            </button>
                        </div>
                        
                        <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-semibold text-gray-600 uppercase w-16 text-center">회차</span>
                                <span class="text-xs font-semibold text-gray-600 uppercase flex-1 text-center">당첨번호</span>
                                <span class="text-xs font-semibold text-gray-600 uppercase w-20 text-center">합성수</span>
                                <span class="text-xs font-semibold text-gray-600 uppercase w-16 text-center">소수</span> <span class="text-xs font-semibold text-gray-600 uppercase w-16 text-center">증감</span>
                            </div>
                        </div>
                        
                        <div id="drawsList" class="max-h-[600px] overflow-y-auto custom-scrollbar p-6 pt-0">
                            <div class="flex items-center justify-center p-10 text-gray-500"><span class="material-symbols-outlined animate-spin mr-2">progress_activity</span>데이터를 불러오는 중...</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="statsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">합성수 당첨 통계</h2>
                        <p class="text-sm text-gray-600 mt-1">각 회차별 합성수 당첨 현황</p>
                    </div>
                    <button onclick="closeStatsModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors"><span class="material-symbols-outlined text-gray-500">close</span></button>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-700">분석 회차 범위</span>
                        <div class="flex gap-2">
                            <button onclick="setStatsRange(50)" id="statsPreset50" class="px-3 py-1 text-xs font-medium bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">50회</button>
                            <button onclick="setStatsRange(100)" id="statsPreset100" class="px-3 py-1 text-xs font-medium bg-blue-500 text-white rounded-lg transition-colors">100회</button>
                            <button onclick="setStatsRange(500)" id="statsPreset500" class="px-3 py-1 text-xs font-medium bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">500회</button>
                            <button onclick="setStatsRange(1203)" id="statsPreset1203" class="px-3 py-1 text-xs font-medium bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">전체</button>
                        </div>
                    </div>
                    <input type="range" id="statsRangeSlider" min="10" max="1203" value="100" oninput="updateStatsRange(this.value)"/>
                    <div class="mt-2 text-sm text-gray-600">최근 <span id="statsRangeDisplay" class="font-bold text-blue-600">100</span>회 분석</div>
                </div>
            </div>
            <div class="overflow-x-auto custom-scrollbar flex-1 p-6">
                <div class="mb-4 flex gap-2">
                    <button onclick="selectAllComposites()" class="px-3 py-1.5 bg-gray-700 text-white text-xs rounded hover:bg-gray-800">전체 선택</button>
                    <button onclick="deselectAllComposites()" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300">전체 해제</button>
                </div>
                <table class="w-full border-collapse">
                    <thead id="statsTableHead"></thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchLottoData();
        });

        async function fetchLottoData() {
            try {
                const { data, error } = await supabaseClient
                    .from('lotto_draws') 
                    .select('*')
                    .order('round', { ascending: false })
                    .range(0, 5000); 

                if (error) throw error;

                allDrawData = data.map(item => {
                    const numbers = item.numbers || [];
                    const compositeCount = numbers.filter(n => isComposite(n)).length;
                    const primeCount = numbers.filter(n => isPrime(n)).length; // 소수 개수 계산
                    return { ...item, numbers, compositeCount, primeCount };
                });

                const totalCount = allDrawData.length;
                document.getElementById('rangeSlider').max = totalCount;
                document.getElementById('totalRangeDisplay').textContent = `최대 ${totalCount}회`;
                
                setDefaultFilter();
                updateRange(currentRange);
                setTimeout(displayAIAnalysis, 500);

            } catch (err) {
                console.error("데이터 로드 실패:", err);
                document.getElementById('drawsList').innerHTML = `<div class="text-center p-10 text-red-500">데이터를 불러오는데 실패했습니다.<br>오류 내용: ${err.message}<br>(lotto_draws 테이블 확인 필요)</div>`;
            }
        }

        function setDefaultFilter() {
            const last10 = allDrawData.slice(0, 10);
            if (last10.length === 0) return;

            let min = 6, max = 0;
            last10.forEach(d => {
                if (d.compositeCount < min) min = d.compositeCount;
                if (d.compositeCount > max) max = d.compositeCount;
            });

            activeFilters.clear();
            for (let i = min; i <= max; i++) {
                activeFilters.add(i);
            }
            updateUIState();
        }

        function toggleSelection(count) {
            if (activeFilters.has(count)) {
                activeFilters.delete(count);
            } else {
                activeFilters.add(count);
            }
            updateUIState();
        }

        function updateUIState() {
            for (let i = 0; i <= 6; i++) {
                const btn = document.getElementById(`filter-btn-${i}`);
                const card = document.getElementById(`card-${i}`);
                
                if (activeFilters.has(i)) {
                    btn.classList.add('filter-btn-active');
                    card.classList.add('stat-card-active');
                } else {
                    btn.classList.remove('filter-btn-active');
                    card.classList.remove('stat-card-active');
                }
            }
        }

        function updateRange(value) {
            currentRange = parseInt(value);
            document.getElementById('rangeDisplay').innerText = currentRange;
            document.getElementById('displayedCount').innerText = currentRange;
            
            const maxVal = allDrawData.length || 1203;
            const percent = (currentRange / maxVal) * 100;
            document.getElementById('rangeSlider').style.setProperty('--value-percent', percent + '%');

            calculateStats();
            drawChart();
            renderDrawsList();
        }

        function setRange(value) {
            const max = allDrawData.length;
            const target = value > max ? max : value;
            document.getElementById('rangeSlider').value = target;
            updateRange(target);
        }

        function calculateStats() {
            const targetData = allDrawData.slice(0, currentRange);
            const counts = [0, 0, 0, 0, 0, 0, 0];

            targetData.forEach(draw => {
                if (draw.compositeCount >= 0 && draw.compositeCount <= 6) {
                    counts[draw.compositeCount]++;
                }
            });

            const total = targetData.length;
            for (let i = 0; i <= 6; i++) {
                const percent = total === 0 ? 0 : ((counts[i] / total) * 100).toFixed(1);
                document.getElementById(`count_${i}`).innerText = `${percent}%`;
            }
        }

        function drawChart() {
            const ctx = document.getElementById('compositeChart').getContext('2d');
            const targetData = allDrawData.slice(0, currentRange);

            if (compositeChart) {
                compositeChart.destroy();
            }

            let labels, data, type, datasets;

            if (chartMode === 'distribution') {
                type = 'bar';
                const counts = [0, 0, 0, 0, 0, 0, 0];
                targetData.forEach(d => counts[d.compositeCount]++);
                labels = ['0개', '1개', '2개', '3개', '4개', '5개', '6개'];
                data = counts.map(c => (c / targetData.length * 100).toFixed(1));
                datasets = [{
                    label: '당첨율 (%)',
                    data: data,
                    backgroundColor: '#3B82F6',
                    borderRadius: 4,
                    barThickness: 40
                }];
            } else {
                type = 'line';
                const chartData = targetData.slice(0, 30).reverse();
                labels = chartData.map(d => `${d.round}회`);
                data = chartData.map(d => d.compositeCount);
                datasets = [{
                    label: '합성수 개수',
                    data: data,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: '#2563EB',
                    pointRadius: 3,
                    fill: true,
                    tension: 0.3
                }];
            }

            compositeChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => value,
                            font: { weight: 'bold', size: 11 },
                            color: '#4B5563',
                            display: chartMode === 'distribution'
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { 
                                drawOnChartArea: false, // 내부 그리드 제거
                                drawTicks: true
                            },
                            border: { display: true }, // 축선 표시
                            display: true
                        },
                        x: { 
                            grid: { 
                                drawOnChartArea: false, // 내부 그리드 제거
                                drawTicks: true 
                            },
                            border: { display: true }, // 축선 표시
                            display: true
                        }
                    },
                    animation: { duration: 500 }
                },
                plugins: [ChartDataLabels]
            });
        }

        function changeChartMode(mode) {
            chartMode = mode;
            document.getElementById('chartTypeDistribution').className = mode === 'distribution' ? 
                "px-4 py-2 text-sm font-medium bg-blue-500 text-white rounded-lg transition-colors" : 
                "px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-lg transition-colors";
            document.getElementById('chartTypeRound').className = mode === 'round' ? 
                "px-4 py-2 text-sm font-medium bg-blue-500 text-white rounded-lg transition-colors" : 
                "px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-lg transition-colors";
            drawChart();
        }

        function renderDrawsList() {
            const list = document.getElementById('drawsList');
            list.innerHTML = '';
            
            const targetData = allDrawData.slice(0, currentRange);

            targetData.forEach((draw, index) => {
                const row = document.createElement('div');
                row.className = `draw-row flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer`;
                row.id = `row-${index}`;
                row.onclick = () => highlightTenDraws(index);

                let numbersHtml = '';
                draw.numbers.forEach(num => {
                    const isComp = isComposite(num);
                    const ballClass = isComp ? 'ball-composite' : 'ball-normal';
                    numbersHtml += `<span class="w-8 h-8 rounded-full flex items-center justify-center text-sm ${ballClass}">${num}</span>`;
                });

                let diff = 0;
                if (index < allDrawData.length - 1) {
                    const prev = allDrawData[index + 1].compositeCount;
                    diff = draw.compositeCount - prev;
                }
                
                const diffColor = diff > 0 ? 'text-red-500' : (diff < 0 ? 'text-blue-500' : 'text-gray-400');
                const diffIcon = diff > 0 ? '▲' : (diff < 0 ? '▼' : '-');
                const diffText = diff === 0 ? '-' : Math.abs(diff);

                row.innerHTML = `
                    <div class="w-16 text-center font-bold text-gray-800">${draw.round}회</div>
                    <div class="flex-1 flex justify-center gap-1.5">${numbersHtml}</div>
                    <div class="w-20 text-center font-bold text-blue-600">${draw.compositeCount}</div>
                    <div class="w-16 text-center font-bold text-purple-600">${draw.primeCount}</div> <div class="w-16 text-center ${diffColor} text-xs font-bold">${diffIcon} ${diffText}</div>
                `;
                list.appendChild(row);
            });
        }

        function highlightTenDraws(startIndex) {
            const existing = document.querySelectorAll('.row-highlight');
            existing.forEach(el => el.classList.remove('row-highlight'));

            const endIndex = Math.min(startIndex + 9, currentRange - 1);
            for (let i = startIndex; i <= endIndex; i++) {
                const row = document.getElementById(`row-${i}`);
                if (row) row.classList.add('row-highlight');
            }
        }

        function formatAIResponse(text) {
            if (!text) return "";
            return text
                .replace(/{{number:(.*?)}}/g, '<span class="text-red-600 bg-red-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{up:(.*?)}}/g, '<span class="text-green-600 bg-green-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{down:(.*?)}}/g, '<span class="text-orange-600 bg-orange-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{warn:(.*?)}}/g, '<span class="text-yellow-600 bg-yellow-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{good:(.*?)}}/g, '<span class="text-blue-600 bg-blue-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{range:(.*?)}}/g, '<span class="text-purple-600 bg-purple-50 font-bold px-1 rounded">$1</span>');
        }

        async function displayAIAnalysis() {
            const aiContent = document.getElementById('aiAnalysisContent');
            
            const mockAnalysis = {
                trend: "최근 10회차 흐름을 볼 때 합성수의 출현 빈도는 {{number:4.2개}}로 평균보다 약간 상회하고 있습니다. 특히 {{good:4개와 5개}}가 연속적으로 출현하며 강한 상승 모멘텀을 형성하고 있습니다.",
                pattern: "현재 {{number:0개}} 또는 {{number:1개}}와 같은 극단적인 값의 출현 확률은 {{warn:매우 낮아진 상태}}입니다. 이는 데이터가 중앙값으로 회귀하려는 성질을 보이고 있음을 의미합니다.",
                recommendation: "안정적인 당첨을 위해서는 {{range:3~5개}} 사이의 합성수를 조합하는 것이 가장 이상적입니다. 특히 지난 회차의 강세가 이어질 가능성이 높으므로 {{good:5개}} 비중을 조금 높이는 것을 추천합니다."
            };

            aiContent.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-start gap-3"><span class="material-symbols-outlined text-purple-600 text-2xl mt-1">trending_up</span><div class="flex-1"><h4 class="font-bold text-gray-900 mb-1">트렌드 심층 분석</h4><p class="text-sm text-gray-700 leading-relaxed">${formatAIResponse(mockAnalysis.trend)}</p></div></div>
                    <div class="flex items-start gap-3"><span class="material-symbols-outlined text-green-600 text-2xl mt-1">insights</span><div class="flex-1"><h4 class="font-bold text-gray-900 mb-1">패턴 정밀 진단</h4><p class="text-sm text-gray-700 leading-relaxed">${formatAIResponse(mockAnalysis.pattern)}</p></div></div>
                    <div class="flex items-start gap-3"><span class="material-symbols-outlined text-blue-600 text-2xl mt-1">lightbulb</span><div class="flex-1"><h4 class="font-bold text-gray-900 mb-1">전략 가이드</h4><p class="text-sm text-gray-700 leading-relaxed">${formatAIResponse(mockAnalysis.recommendation)}</p></div></div>
                </div>`;
        }

        function refreshAIAnalysis() {
            const aiContent = document.getElementById('aiAnalysisContent');
            aiContent.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <span class="material-symbols-outlined text-4xl text-purple-400 mb-2 animate-spin">refresh</span>
                        <p class="text-sm text-gray-600">심층 분석을 진행하고 있습니다...</p>
                    </div>
                </div>
            `;
            setTimeout(displayAIAnalysis, 1000);
        }

        let statsRange = 100;

        function openStatsModal() {
            document.getElementById('statsModal').classList.remove('hidden');
            renderStatsTable();
        }

        function closeStatsModal() {
            document.getElementById('statsModal').classList.add('hidden');
        }

        function setStatsRange(val) {
            const max = allDrawData.length;
            statsRange = val > max ? max : val;
            document.getElementById('statsRangeSlider').value = statsRange;
            updateStatsRange(statsRange);
        }

        function updateStatsRange(val) {
            statsRange = parseInt(val);
            document.getElementById('statsRangeDisplay').innerText = statsRange;
            renderStatsTable();
        }

        // 미출현 기간 계산 함수 (해당 회차 기준 과거 탐색)
        function getMissCount(startIdx, num) {
            let count = 0;
            // startIdx는 현재 행의 인덱스. allDrawData[startIdx]가 현재 행 데이터.
            // 과거 데이터는 startIdx + 1 부터 끝까지.
            for(let i = startIdx + 1; i < allDrawData.length; i++) {
                count++;
                if(allDrawData[i].numbers.includes(num)) {
                    return count;
                }
            }
            return ''; // 이전 기록이 없을 경우 공백
        }

        function renderStatsTable() {
            const thead = document.getElementById('statsTableHead');
            const tbody = document.getElementById('statsTableBody');
            const compositeList = Array.from(composites).sort((a,b) => a-b);

            // 헤더
            let headerHtml = `
                <tr class="bg-gray-50 border-b border-gray-200">
                    <th colspan="2" class="sticky left-0 z-20 bg-gray-50 border border-gray-300 border-r-2 border-r-gray-500 px-3 py-2 text-[11px] font-semibold text-red-600">제외수 필터</th>
            `;
            compositeList.forEach(num => {
                headerHtml += `<th class="bg-gray-50 border border-gray-300 px-1 py-2"><input type="checkbox" id="exclude_${num}" onchange="syncExcludeFilter()" class="w-3 h-3 text-red-600 rounded focus:ring-red-500"></th>`;
            });
            headerHtml += `</tr><tr>
                <th class="sticky left-0 z-20 bg-gray-100 border border-gray-300 px-2 py-2 text-[11px] font-semibold text-gray-700 w-12">회차</th>
                <th class="sticky left-12 z-10 bg-gray-100 border border-gray-300 border-r-2 border-r-gray-500 px-2 py-2 text-[11px] font-semibold text-blue-600 w-16">당첨</th>
            `;
            compositeList.forEach(num => {
                headerHtml += `<th class="bg-gray-100 border border-gray-300 px-1 py-2 text-[11px] font-semibold text-gray-700">${num}</th>`;
            });
            headerHtml += `</tr>`;
            thead.innerHTML = headerHtml;

            // 바디
            let bodyHtml = '';
            const data = allDrawData.slice(0, statsRange);
            
            data.forEach((draw, index) => {
                bodyHtml += `<tr>
                    <td class="sticky left-0 z-10 bg-white border border-gray-300 px-2 py-1 text-[11px] font-bold text-center">${draw.round}</td>
                    <td class="sticky left-12 z-10 bg-white border border-gray-300 border-r-2 border-r-gray-500 px-2 py-1 text-[11px] font-bold text-center text-blue-600">${draw.compositeCount}</td>
                `;
                compositeList.forEach(num => {
                    const isHit = draw.numbers.includes(num);
                    let cellContent = '';
                    let cellClass = '';

                    if (isHit) {
                        // 당첨: DarkGray 배경
                        cellClass = 'bg-gray-700'; 
                        cellContent = ''; 
                    } else {
                        // 미당첨: 미출현 기간 표시 (작은 회색 숫자)
                        const miss = getMissCount(index, num);
                        cellClass = 'bg-white';
                        cellContent = `<span class="text-[10px] text-gray-400">${miss}</span>`;
                    }
                    bodyHtml += `<td class="border border-gray-300 px-1 py-1 text-center ${cellClass}">${cellContent}</td>`;
                });
                bodyHtml += `</tr>`;
            });
            tbody.innerHTML = bodyHtml;
            
            compositeList.forEach(num => {
                 const chk = document.getElementById(`exclude_${num}`);
                 if(chk && excludedComposites.has(num)) chk.checked = true;
            });
        }

        function syncExcludeFilter() {
            const checkboxes = document.querySelectorAll('input[id^="exclude_"]:checked');
            const excluded = Array.from(checkboxes).map(cb => parseInt(cb.id.replace('exclude_', '')));
            
            excludedComposites.clear();
            excluded.forEach(n => excludedComposites.add(n));
            
            document.getElementById('excludeNumbersInput').value = excluded.join(', ');
        }

        function selectAllComposites() {
            const cbs = document.querySelectorAll('input[id^="exclude_"]');
            cbs.forEach(cb => cb.checked = true);
            syncExcludeFilter();
        }

        function deselectAllComposites() {
            const cbs = document.querySelectorAll('input[id^="exclude_"]');
            cbs.forEach(cb => cb.checked = false);
            syncExcludeFilter();
        }
    </script>
</body>
</html>