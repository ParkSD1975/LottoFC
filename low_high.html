<!DOCTYPE html>
<html class="light" lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Lotto Lab - ì €ê³  ë¹„ìœ¨ (ì‹¬ì¸µë¶„ì„)</title>
    <link as="style" crossorigin="" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="js/layout.js"></script>
    
    <script>
        // âœ… Supabase ì„¤ì •
        const SUPABASE_URL = 'https://dkcflmyoscudawleglzb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrY2ZsbXlvc2N1ZGF3bGVnbHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDQ4OTAsImV4cCI6MjA4MzEyMDg5MH0.haAvbpScvMJv1uqH_tk-0fUlJNCpHnlWBtYzX6YFweo';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allDrawData = []; 
        let lowHighChart = null;
        let currentRange = 100;
        let activeFilters = new Set();
        let advancedStats = {}; // ì‹¬ì¸µ ë¶„ì„ ë°ì´í„° ì €ì¥
        let highlightTargetRound = null; // í•˜ì´ë¼ì´íŠ¸ ê¸°ì¤€ íšŒì°¨

        // ì €ê³  ì´ë¡ ì  í†µê³„
        const THEORETICAL_STATS = {
            '6:0': { count: 74613, percent: 0.92 },
            '5:1': { count: 605682, percent: 7.44 },
            '4:2': { count: 1850695, percent: 22.72 },
            '3:3': { count: 2727340, percent: 33.48 },
            '2:4': { count: 2045505, percent: 25.11 },
            '1:5': { count: 740278, percent: 9.09 },
            '0:6': { count: 100947, percent: 1.24 }
        };

        // ğŸ¨ íŒ¨í„´ë³„ ê³ ìœ  ìƒ‰ìƒ (ì‹œê°ì  êµ¬ë¶„ ê°•í™”)
        const RATIO_COLORS = {
            '6:0': { bg: '#FEE2E2', text: '#991B1B', border: '#EF4444' }, // ë¹¨ê°• (ê·¹ë‹¨)
            '5:1': { bg: '#FFEDD5', text: '#9A3412', border: '#F97316' }, // ì£¼í™©
            '4:2': { bg: '#FEF9C3', text: '#854D0E', border: '#EAB308' }, // ë…¸ë‘
            '3:3': { bg: '#DCFCE7', text: '#166534', border: '#22C55E' }, // ì´ˆë¡ (ê°€ì¥ ì•ˆì •)
            '2:4': { bg: '#DBEAFE', text: '#1E40AF', border: '#3B82F6' }, // íŒŒë‘
            '1:5': { bg: '#E0E7FF', text: '#3730A3', border: '#6366F1' }, // ë‚¨ìƒ‰
            '0:6': { bg: '#F3E8FF', text: '#6B21A8', border: '#A855F7' }  // ë³´ë¼ (ê·¹ë‹¨)
        };

        const RATIOS = ['6:0', '5:1', '4:2', '3:3', '2:4', '1:5', '0:6'];

        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: { colors: { "active-green": "#E6FFED", "active-text": "#16A34A", "lotto-blue": "#3B82F6" }, fontFamily: { "sans": ["Pretendard", "Inter", "sans-serif"] } },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        
        .ball-base { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 14px; font-weight: 700; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .ball-low { background-color: #3B82F6; border: 1px solid #2563EB; }
        .ball-high { background-color: #EF4444; border: 1px solid #DC2626; }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #E5E7EB; outline: none; cursor: pointer;
            background-image: linear-gradient(#3B82F6, #3B82F6); background-size: var(--value-percent, 0%) 100%; background-repeat: no-repeat;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #3B82F6; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.1s; border: 2px solid white;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); background: #2563EB; }
        .ai-section { background: linear-gradient(135deg, #E0E7FF 0%, #EDE9FE 50%, #FCE7F3 100%); }

        .filter-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; border: 1px solid #E5E7EB; background: white; color: #374151; transition: all 0.2s; cursor: pointer; }
        .filter-btn:hover { border-color: #3B82F6; color: #3B82F6; }
        .filter-btn.active { background: #3B82F6; color: white; border-color: #3B82F6; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }

        .stat-card { border: 1px solid #E5E7EB; border-radius: 12px; padding: 12px; background: white; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden;}
        .stat-card:hover { transform: translateY(-2px); border-color: #3B82F6; }
        .stat-card.active { background: #3B82F6; color: white; border-color: #3B82F6; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
        .stat-card.active p, .stat-card.active span, .stat-card.active div { color: white !important; }
        
        /* âœ… ìˆ˜ì •ëœ ë¶€ë¶„: í™œì„±í™”ëœ ì¹´ë“œì˜ ë±ƒì§€ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© (ì‹œì¸ì„± ê°œì„ ) */
        .stat-card.active .ratio-badge {
            background-color: #FFFFFF !important;
            color: #374151 !important; /* ì§„í•œ íšŒìƒ‰ í…ìŠ¤íŠ¸ */
            border-color: #FFFFFF !important;
        }

        /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .ratio-badge { padding: 4px 10px; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; display: inline-block; }
        
        /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .highlight-range { background-color: #FEF3C7 !important; } /* ë…¸ë€ìƒ‰ ë°°ê²½ */
    </style>
</head>
<body class="bg-[#F9FAFB] font-sans antialiased">
    <div class="flex flex-col h-screen w-full">
        <div id="gnb-container"></div>

        <div class="flex flex-1 overflow-hidden">
            <aside id="lnb-container" class="w-56 bg-white border-r border-gray-200 overflow-y-auto custom-scrollbar flex-shrink-0">
            </aside>

            <main class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                <div class="max-w-7xl mx-auto space-y-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 mb-1">ì €ê³  ë¹„ìœ¨ ë¶„ì„</h1>
                        <p class="text-sm text-gray-600">ë‹¹ì²¨ë²ˆí˜¸ 6ê°œì˜ ì €(1~22)ì™€ ê³ (23~45) ë¹„ìœ¨ì„ ë‹¤ê°ë„ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                    </div>

                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                        <div class="grid grid-cols-7 gap-3 mb-6">
                             <div id="statCardsContainer" class="col-span-7 grid grid-cols-7 gap-3"></div>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-5 mb-6 border border-gray-100">
                            <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-blue-500">analytics</span> íŒ¨í„´ ì‹¬ì¸µ ë¶„ì„ (ì—°ì†/ë¯¸ì¶œí˜„)
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4" id="advancedStatsContainer">
                                </div>
                        </div>

                        <div class="ai-section rounded-2xl p-6 mb-6">
                            <div class="flex items-center justify-between mb-5">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-purple-600">psychology</span>
                                    <h3 class="text-lg font-bold text-gray-900">AI ì‹¬ì¸µ ë¶„ì„</h3>
                                </div>
                                <button onclick="refreshAIAnalysis()" class="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700">
                                    <span class="material-symbols-outlined text-lg">refresh</span>ë¶„ì„ ìƒˆë¡œê³ ì¹¨
                                </button>
                            </div>
                            <div id="aiAnalysisContent" class="text-sm text-gray-700 leading-relaxed text-left">
                                <div class="flex items-center gap-2 text-gray-500">
                                    <span class="material-symbols-outlined text-lg animate-spin">progress_activity</span>
                                    <span>AIê°€ ì—°ì† ì¶œí˜„ ë° ë¯¸ì¶œí˜„ íŒ¨í„´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-900">ì €ê³  ë¹„ìœ¨ ë¶„í¬ (ë¹„ìœ¨ %)</h3>
                            </div>
                            <div class="h-80"><canvas id="lowHighChart"></canvas></div>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-900">ë¶„ì„ íšŒì°¨ ë²”ìœ„</h3>
                                <div class="flex items-center gap-2">
                                    <button onclick="setRange(50)" id="preset50" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">50íšŒ</button>
                                    <button onclick="setRange(100)" id="preset100" class="px-3 py-1.5 text-sm font-medium bg-blue-500 text-white rounded-lg transition-colors">100íšŒ</button>
                                    <button onclick="setRange(500)" id="preset500" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">500íšŒ</button>
                                    <button onclick="setRange(1203)" id="preset1203" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">ì „ì²´</button>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <input type="range" id="rangeSlider" min="10" max="1203" value="100" oninput="updateRange(this.value)"/>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">ìµœê·¼ <span id="rangeDisplay" class="font-bold text-blue-600">100</span>íšŒ ë¶„ì„</span>
                                    <span id="totalRangeDisplay" class="text-gray-500">ìµœëŒ€ 1,203íšŒ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900">í•„í„°</h3>
                            <a href="#filter-page" class="flex items-center gap-1 text-xs font-medium text-gray-500 hover:text-gray-800 transition-colors"><span class="material-symbols-outlined text-sm">open_in_new</span>í•„í„° í˜ì´ì§€ ê°€ê¸°</a>
                        </div>
                        <div class="flex flex-col gap-6">
                            <div class="flex items-center justify-center gap-4 flex-wrap" id="ratioFilters"></div>
                            <div class="h-px bg-gray-100 w-full"></div>
                            <div class="flex items-center gap-3 ml-auto">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="applyFilterCheck" onchange="applyFilter()" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                </label>
                                <label for="applyFilterCheck" class="text-sm font-medium text-gray-700 cursor-pointer">í•„í„° ì ìš©</label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                            <div><h3 class="text-lg font-bold text-gray-900 mb-1">íšŒì°¨ë³„ ë‹¹ì²¨ë²ˆí˜¸ ë° ì €ê³  ë¹„ìœ¨</h3><p class="text-sm text-gray-600">ìµœê·¼ <span id="displayedCount">100</span>íšŒì°¨ í‘œì‹œ (í´ë¦­ì‹œ 10íšŒì°¨ í•˜ì´ë¼ì´íŠ¸)</p></div>
                            <button onclick="openStatsModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors">
                                <span class="material-symbols-outlined text-lg">bar_chart</span>í†µê³„ ë³´ê¸°
                            </button>
                        </div>
                        <div class="overflow-x-auto custom-scrollbar">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 w-20">íšŒì°¨</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600">ë‹¹ì²¨ë²ˆí˜¸</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 w-24">ì €ê³  ë¹„ìœ¨</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 w-24">ì €(Low)</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 w-24">ê³ (High)</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 w-32">ìµœê·¼ 10íšŒ ì¶œí˜„</th>
                                    </tr>
                                </thead>
                                <tbody id="drawsList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="statsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <div><h2 class="text-xl font-bold text-gray-900">ì €ê³  í†µê³„</h2><p class="text-sm text-gray-600 mt-1">ë¹„ìœ¨ë³„ ìƒì„¸ ë¶„ì„</p></div>
                <button onclick="closeStatsModal()" class="p-2 hover:bg-gray-100 rounded-lg"><span class="material-symbols-outlined text-gray-500">close</span></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <table class="w-full">
                    <thead class="sticky top-0 bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase w-16">ì„ íƒ</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase">ë¹„ìœ¨ (ì €:ê³ )</th>
                            <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase">ì¡°í•©ìˆ˜</th>
                            <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase">ì¡°í•©ë¹„ì¤‘</th>
                            <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase">ì¶œí˜„ íšŸìˆ˜</th>
                            <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase">ì¶œí˜„ ë¹„ì¤‘</th>
                            <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase w-1/3">ë¶„í¬</th>
                        </tr>
                    </thead>
                    <tbody id="modalStatsBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end"><button onclick="closeStatsModal()" class="px-4 py-2 border rounded hover:bg-gray-50">ë‹«ê¸°</button></div>
        </div>
    </div>

    <script>
        function calculateLowHigh(numbers) {
            let lowCount = 0;
            numbers.forEach(n => { if (n <= 22) lowCount++; });
            let highCount = 6 - lowCount;
            return { low: lowCount, high: highCount, ratio: `${lowCount}:${highCount}` };
        }

        // ğŸ§  ì‹¬ì¸µ í†µê³„ ê³„ì‚° (ì—°ì† ì¶œí˜„, ë¯¸ì¶œí˜„ ë“±)
        function calculateAdvancedStats(data) {
            const stats = {};
            RATIOS.forEach(r => stats[r] = { currentStreak: 0, maxStreak: 0, currentGap: 0, totalCount: 0 });

            // 1. ì—­ìˆœ ìˆœíšŒ (Gap ë° Current Streak ê³„ì‚°)
            let gapCheck = {}; 
            RATIOS.forEach(r => gapCheck[r] = true); // Gap ì²´í¬ ì—¬ë¶€

            for (let i = 0; i < data.length; i++) {
                const ratio = data[i].ratio;
                
                // Gap ê³„ì‚° (ì•„ì§ ì•ˆ ë‚˜ì™”ìœ¼ë©´ +1)
                for (const r of RATIOS) {
                    if (r !== ratio && gapCheck[r]) stats[r].currentGap++;
                    else if (r === ratio) gapCheck[r] = false; // ë‚˜ì˜¤ë©´ Gap ì¹´ìš´íŠ¸ ì¤‘ì§€
                }

                // Current Streak ê³„ì‚° (ìµœì‹  íšŒì°¨ë¶€í„° ì—°ì†ë¨)
                if (i === 0) {
                    stats[ratio].currentStreak = 1;
                    // ì´ì „ íšŒì°¨ë“¤ í™•ì¸í•˜ë©° Streak ì¦ê°€
                    let j = 1;
                    while (j < data.length && data[j].ratio === ratio) {
                        stats[ratio].currentStreak++;
                        j++;
                    }
                }
            }

            // 2. ì „ì²´ ìˆœíšŒ (Max Streak ë° Count ê³„ì‚°)
            let tempStreak = {};
            RATIOS.forEach(r => tempStreak[r] = 0);

            // ë°ì´í„°ëŠ” ìµœì‹ ìˆœ(ë‚´ë¦¼ì°¨ìˆœ)ì´ë¯€ë¡œ ì—­ìˆœ(ì˜¤ë¦„ì°¨ìˆœ)ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ Streak ê³„ì‚° ì •í™•
            const reversedData = [...data].reverse(); 
            
            reversedData.forEach(d => {
                const r = d.ratio;
                stats[r].totalCount++;
                tempStreak[r]++;
                // ë‹¤ë¥¸ ë¹„ìœ¨ë“¤ì€ Streak ì´ˆê¸°í™”
                RATIOS.forEach(other => {
                    if (other !== r) tempStreak[other] = 0;
                });
                // Max Streak ê°±ì‹ 
                if (tempStreak[r] > stats[r].maxStreak) stats[r].maxStreak = tempStreak[r];
            });

            return stats;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const { data, error } = await supabaseClient
                    .from('lotto_draws') 
                    .select('*')
                    .order('round', { ascending: false })
                    .range(0, 5000); 

                if (error) throw error;
                if (!data || data.length === 0) return;

                allDrawData = data.map(item => {
                    const numbers = item.numbers || [];
                    const lh = calculateLowHigh(numbers);
                    return { ...item, numbers, ...lh };
                });
                
                const totalCount = allDrawData.length;
                document.getElementById('rangeSlider').max = totalCount;
                document.getElementById('totalRangeDisplay').textContent = `ìµœëŒ€ ${totalCount.toLocaleString()}íšŒ`;
                document.getElementById('preset1203').setAttribute('onclick', `setRange(${totalCount})`);
                document.getElementById('preset1203').innerText = "ì „ì²´";
                
                // âœ… ìµœê·¼ 10íšŒì°¨ì— ë‚˜ì˜¨ ë¹„ìœ¨ì„ ê¸°ë³¸ í•„í„°ë¡œ ì„¤ì •
                const recent10Data = allDrawData.slice(0, 10);
                recent10Data.forEach(d => activeFilters.add(d.ratio));

                initUI();
                updateRange(currentRange);
                setTimeout(() => { updateSliderBackground(currentRange); }, 100);
            } catch (err) { console.error('Data Load Error:', err); }
        });
        
        function initUI() {
            const statContainer = document.getElementById('statCardsContainer');
            statContainer.innerHTML = '';
            RATIOS.forEach(ratio => {
                const color = RATIO_COLORS[ratio];
                const div = document.createElement('div');
                div.className = `stat-card group transition-all`;
                div.id = `card-${ratio.replace(':', '_')}`;
                div.onclick = () => toggleFilter(ratio);
                
                // ğŸ¨ ì¹´ë“œ ìƒ‰ìƒ ìŠ¤íƒ€ì¼ ì ìš©
                div.innerHTML = `
                    <div class="ratio-badge mb-2" style="background:${color.bg}; color:${color.text}; border:1px solid ${color.border}">
                        ${ratio}
                    </div>
                    <div class="flex items-end gap-1">
                        <span class="text-xl font-bold text-gray-900 ratio-val" id="val-${ratio.replace(':', '_')}">-</span>
                        <span class="text-xs text-gray-500 font-medium mb-1">%</span>
                    </div>
                `;
                statContainer.appendChild(div);
            });

            const filterContainer = document.getElementById('ratioFilters');
            filterContainer.innerHTML = '';
            RATIOS.forEach(ratio => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn shadow-sm text-sm';
                btn.id = `btn-${ratio.replace(':', '_')}`;
                btn.textContent = ratio;
                btn.onclick = () => toggleFilter(ratio);
                filterContainer.appendChild(btn);
            });
            
            updateUIState(); // ì´ˆê¸° í•„í„° ìƒíƒœ ë°˜ì˜
            initChart();
        }

        function toggleFilter(ratio) {
            if (activeFilters.has(ratio)) activeFilters.delete(ratio);
            else activeFilters.add(ratio);
            updateUIState();
            applyFilter();
        }

        function updateUIState() {
            RATIOS.forEach(ratio => {
                const safeId = ratio.replace(':', '_');
                const card = document.getElementById(`card-${safeId}`);
                const btn = document.getElementById(`btn-${safeId}`);
                const isActive = activeFilters.has(ratio);
                
                if (isActive) {
                    card.classList.add('active'); card.classList.remove('hover:bg-gray-50');
                    btn.classList.add('active');
                } else {
                    card.classList.remove('active'); card.classList.add('hover:bg-gray-50');
                    btn.classList.remove('active');
                }
            });
        }
        
        function updateRange(value) {
            currentRange = parseInt(value);
            document.getElementById('rangeDisplay').textContent = value + 'íšŒ';
            updateSliderBackground(value);
            updateStatistics();
            updatePresetButtons(currentRange);
            applyFilter();
            refreshAIAnalysis();
        }
        
        function updateStatistics() {
            if (!allDrawData.length) return;
            const data = allDrawData.slice(0, currentRange);
            const total = data.length;
            
            // ê³ ê¸‰ í†µê³„ ê³„ì‚°
            advancedStats = calculateAdvancedStats(allDrawData); // ì „ì²´ ë°ì´í„° ê¸°ì¤€ Streak/Gap
            // í˜„ì¬ ë²”ìœ„ ë‚´ í†µê³„
            const counts = {};
            RATIOS.forEach(r => counts[r] = 0);
            data.forEach(d => { if (counts[d.ratio] !== undefined) counts[d.ratio]++; });

            // 1. ì¹´ë“œ ì—…ë°ì´íŠ¸
            RATIOS.forEach(ratio => {
                const safeId = ratio.replace(':', '_');
                const count = counts[ratio] || 0;
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                document.getElementById(`val-${safeId}`).textContent = percent;
            });

            // 2. ì‹¬ì¸µ ë¶„ì„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            const advContainer = document.getElementById('advancedStatsContainer');
            advContainer.innerHTML = '';
            RATIOS.forEach(ratio => {
                const s = advancedStats[ratio];
                const color = RATIO_COLORS[ratio];
                
                // Gapì´ í¬ë©´ ê°•ì¡° (ë¹¨ê°„ í…Œë‘ë¦¬)
                const isUrgent = s.currentGap > 10;
                const urgentClass = isUrgent ? 'border-2 border-red-400 bg-red-50' : 'border border-gray-200 bg-white';

                advContainer.innerHTML += `
                    <div class="p-3 rounded-lg ${urgentClass} shadow-sm text-center">
                        <div class="text-xs font-bold mb-1" style="color:${color.text}">${ratio}</div>
                        <div class="text-[10px] text-gray-500">í˜„ì¬ì—°ì† / ìµœëŒ€</div>
                        <div class="font-bold text-gray-800">${s.currentStreak}íšŒ / ${s.maxStreak}íšŒ</div>
                        <div class="mt-2 text-[10px] text-gray-500">ë¯¸ì¶œí˜„(Gap)</div>
                        <div class="font-bold ${isUrgent ? 'text-red-600' : 'text-blue-600'}">${s.currentGap}íšŒ ì „</div>
                    </div>
                `;
            });

            updateChart(counts, total);
        }

        function applyFilter() {
            // âœ… í•„í„° ì²´í¬ë°•ìŠ¤ ìƒíƒœì™€ ê´€ê³„ì—†ì´ ë¦¬ìŠ¤íŠ¸ì—ëŠ” ì „ì²´ ë°ì´í„°ë¥¼ í‘œì‹œ (ì¡°í•©ê¸° ì—°ë™ë§Œ í•„í„° ì²´í¬)
            let data = allDrawData.slice(0, currentRange);
            document.getElementById('displayedCount').textContent = data.length;
            renderDrawsList(data);
        }

        // âœ… ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (í•„í„°ë§ ì œê±°, ìš°ì¸¡ ì—´ ì¶”ê°€, í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥ ì¶”ê°€)
        function renderDrawsList(data) {
            const tbody = document.getElementById('drawsList');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            data.forEach(draw => {
                const tr = document.createElement('tr');
                tr.id = `row-${draw.round}`;
                tr.className = 'border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer';
                tr.onclick = () => highlightRecent10(draw.round);

                // í•˜ì´ë¼ì´íŠ¸ ìƒíƒœ ì ìš©
                if (highlightTargetRound && draw.round <= highlightTargetRound && draw.round > highlightTargetRound - 10) {
                    tr.classList.add('highlight-range');
                }
                
                const numbersHtml = draw.numbers.map(num => {
                    const colorClass = (num <= 22) ? 'ball-low' : 'ball-high';
                    return `<span class="ball-base ${colorClass} mr-1">${String(num).padStart(2, '0')}</span>`
                }).join('');
                
                const badgeColor = RATIO_COLORS[draw.ratio];
                
                // âœ… ìµœê·¼ 10íšŒ ë‹¹ì²¨ìˆ˜ ê³„ì‚° (í•´ë‹¹ íšŒì°¨ ê¸°ì¤€ ê³¼ê±° 10íšŒ)
                const recentCount = countInRecent10(draw.round, draw.ratio);

                tr.innerHTML = `
                    <td class="py-3 px-4 text-sm font-bold text-gray-600">${draw.round}íšŒ</td>
                    <td class="py-3 px-4"><div class="flex justify-center">${numbersHtml}</div></td>
                    <td class="py-3 px-4 text-center">
                        <span class="ratio-badge" style="background:${badgeColor.bg}; color:${badgeColor.text}; border:1px solid ${badgeColor.border}">
                            ${draw.ratio}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center text-sm font-medium text-gray-700">${draw.low}</td>
                    <td class="py-3 px-4 text-center text-sm font-medium text-gray-700">${draw.high}</td>
                    <td class="py-3 px-4 text-center text-sm font-bold text-gray-800">${recentCount}íšŒ</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // âœ… í•´ë‹¹ íšŒì°¨ ê¸°ì¤€ ìµœê·¼ 10íšŒ(ìì‹  í¬í•¨) ë‚´ íŠ¹ì • ë¹„ìœ¨ ì¶œí˜„ íšŸìˆ˜ ê³„ì‚°
        function countInRecent10(targetRound, targetRatio) {
            const index = allDrawData.findIndex(d => d.round === targetRound);
            if (index === -1) return '-';
            
            // allDrawDataëŠ” ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ë˜ì–´ ìˆìŒ
            const slice = allDrawData.slice(index, index + 10);
            const count = slice.filter(d => d.ratio === targetRatio).length;
            return count;
        }

        // âœ… í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥ êµ¬í˜„
        function highlightRecent10(round) {
            highlightTargetRound = round;
            applyFilter(); // ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë Œë”ë§
        }
        
        function initChart() {
            const ctx = document.getElementById('lowHighChart').getContext('2d');
            lowHighChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: RATIOS,
                    datasets: [{
                        label: 'ë¹„ìœ¨(%)',
                        data: Array(7).fill(0),
                        backgroundColor: RATIOS.map(r => RATIO_COLORS[r].border), 
                        borderWidth: 0,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end', align: 'top', color: '#374151', font: { weight: 'bold', size: 11 },
                            formatter: (val) => val > 0 ? val + '%' : ''
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false }, max: 100 },
                        x: { grid: { display: false } }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            toggleFilter(RATIOS[index]);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function updateChart(counts, total) {
            if (!lowHighChart) return;
            const values = RATIOS.map(r => total > 0 ? ((counts[r] || 0) / total * 100).toFixed(1) : 0);
            
            // ì„ íƒëœ ê²ƒë§Œ ì§„í•˜ê²Œ í‘œì‹œ ë¡œì§ì€ ìœ ì§€í•˜ë˜, ê¸°ë³¸ ìƒ‰ìƒì€ ì•Œë¡ë‹¬ë¡í•˜ê²Œ
            const bgColors = RATIOS.map(r => {
                const baseColor = RATIO_COLORS[r].border;
                // í•„í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜, í•´ë‹¹ ë¹„ìœ¨ì´ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ì›ìƒ‰, ì•„ë‹ˆë©´ íˆ¬ëª…ë„ ì¡°ì ˆ
                if (activeFilters.size === 0 || activeFilters.has(r)) return baseColor;
                return baseColor + '40'; // 25% opacity
            });
            
            lowHighChart.data.datasets[0].data = values;
            lowHighChart.data.datasets[0].backgroundColor = bgColors;
            lowHighChart.update();
        }

        function openStatsModal() {
            const tbody = document.getElementById('modalStatsBody');
            tbody.innerHTML = '';
            const data = allDrawData.slice(0, currentRange);
            const total = data.length;
            const counts = {};
            RATIOS.forEach(r => counts[r] = 0);
            data.forEach(d => { if(counts[d.ratio] !== undefined) counts[d.ratio]++; });

            RATIOS.forEach(ratio => {
                const count = counts[ratio];
                const percent = total > 0 ? ((count/total)*100).toFixed(1) : 0;
                const isSelected = activeFilters.has(ratio);
                const theo = THEORETICAL_STATS[ratio];
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';
                tr.innerHTML = `
                    <td class="py-3 px-4 text-center"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" ${isSelected ? 'checked' : ''} onchange="toggleFilter('${ratio}'); openStatsModal();" /></td>
                    <td class="py-3 px-4 font-bold" style="color:${RATIO_COLORS[ratio].text}">${ratio}</td>
                    <td class="py-3 px-4 text-center text-gray-600">${theo.count.toLocaleString()}</td>
                    <td class="py-3 px-4 text-center text-gray-600">${theo.percent}%</td>
                    <td class="py-3 px-4 text-center font-bold text-gray-900">${count}íšŒ</td>
                    <td class="py-3 px-4 text-center font-bold text-blue-600">${percent}%</td>
                    <td class="py-3 px-4"><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="h-2.5 rounded-full" style="width: ${percent}%; background-color:${RATIO_COLORS[ratio].border}"></div></div></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('statsModal').classList.remove('hidden');
        }
        function closeStatsModal() { document.getElementById('statsModal').classList.add('hidden'); }

        function updateSliderBackground(value) {
            const total = allDrawData.length || 1203;
            const slider = document.getElementById('rangeSlider');
            const percent = ((value - 1) / (total - 1)) * 100;
            slider.style.setProperty('--value-percent', percent + '%');
        }
        function setRange(value) {
            const maxVal = allDrawData.length || 1203;
            const safeValue = value > maxVal ? maxVal : value;
            document.getElementById('rangeSlider').value = safeValue;
            updateRange(safeValue);
        }
        function updatePresetButtons(value) {
            const maxVal = allDrawData.length || 1203;
            const ids = {50: 'preset50', 100: 'preset100', 500: 'preset500', 1203: 'preset1203'};
            Object.keys(ids).forEach(key => {
                const btn = document.getElementById(ids[key]);
                const target = key == 1203 ? maxVal : parseInt(key);
                if (target == value) btn.className = 'px-3 py-1.5 text-sm font-medium bg-lotto-blue text-white rounded-lg transition-colors';
                else btn.className = 'px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors';
            });
        }

        // âœ… AI ë¶„ì„ í¬ë§·íŒ… (ì•Œë¡ë‹¬ë¡ íƒœê·¸ ì ìš©)
        function formatAIResponse(text) {
            if (!text) return "";
            return text
                .replace(/{{number:(.*?)}}/g, '<span class="text-red-600 bg-red-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{up:(.*?)}}/g, '<span class="text-green-600 bg-green-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{down:(.*?)}}/g, '<span class="text-orange-600 bg-orange-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{warn:(.*?)}}/g, '<span class="text-yellow-600 bg-yellow-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{good:(.*?)}}/g, '<span class="text-blue-600 bg-blue-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{range:(.*?)}}/g, '<span class="text-purple-600 bg-purple-50 font-bold px-1 rounded">$1</span>');
        }

        async function refreshAIAnalysis() {
            const aiContent = document.getElementById('aiAnalysisContent');
            aiContent.innerHTML = `<div class="flex items-center gap-2 text-gray-500"><span class="material-symbols-outlined text-lg animate-spin">progress_activity</span><span>AIê°€ ë°ì´í„°ë¥¼ ì‹¬ì¸µ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span></div>`;

            const data = allDrawData.slice(0, currentRange);
            const recentDraws = data.slice(0, 10).map(d => `${d.round}íšŒ(${d.ratio})`).join(', ');
            
            const contextStats = {};
            RATIOS.forEach(r => {
                contextStats[r] = {
                    streak: advancedStats[r].currentStreak,
                    maxStreak: advancedStats[r].maxStreak,
                    gap: advancedStats[r].currentGap
                };
            });

            try {
                // âœ… AI ìš”ì²­ ìˆ˜ì • (ì €ê³  ë¹„ìœ¨ ì‹¬ë„ ê¹Šì€ ë¶„ì„ ë° íƒœê·¸ ì‚¬ìš© ìš”ì²­)
                const { data: analysis, error } = await supabaseClient.functions.invoke('analyze-lotto', {
                    body: { 
                        currentRange, 
                        min: 0, max: 6, 
                        recentDraws, 
                        type: 'ì €ê³ ',
                        advancedContext: JSON.stringify(contextStats),
                        prompt: `ì €ê³  ë¹„ìœ¨ì— ëŒ€í•œ ì‹¬ë„ ê¹Šì€ ë¶„ì„ì„ ì œê³µí•´ì¤˜. ìµœê·¼ ì¶”ì„¸, íŒ¨í„´, ê·¸ë¦¬ê³  ë‹¤ìŒ íšŒì°¨ ì¶”ì²œ ì „ëµì„ ìƒì„¸í•˜ê²Œ ì„¤ëª…í•´. ì¤‘ìš”í•œ ìˆ«ìë‚˜ í‚¤ì›Œë“œëŠ” {{number:ê°’}}, {{up:ìƒìŠ¹}}, {{down:í•˜ë½}}, {{warn:ì£¼ì˜}}, {{good:ì¶”ì²œ}}, {{range:êµ¬ê°„}} íƒœê·¸ë¥¼ ì‚¬ìš©í•´ì„œ ê°•ì¡°í•´ì¤˜.`
                    }
                });

                if (error) throw error;

                aiContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-purple-600 text-2xl mt-1">trending_up</span>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 mb-1">ì €ê³  ì‹¬ì¸µ íŠ¸ë Œë“œ</h4>
                                <p class="text-sm text-gray-700 leading-relaxed">${formatAIResponse(analysis.trend)}</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-green-600 text-2xl mt-1">insights</span>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 mb-1">íŒ¨í„´ ì •ë°€ ë¶„ì„</h4>
                                <p class="text-sm text-gray-700 leading-relaxed">${formatAIResponse(analysis.pattern)}</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-blue-600 text-2xl mt-1">lightbulb</span>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 mb-1">AI ì¶”ì²œ ì „ëµ</h4>
                                <p class="text-sm text-gray-700 leading-relaxed">${formatAIResponse(analysis.recommendation)}</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error("AI Error:", err);
                aiContent.innerHTML = `<div class="text-red-500 text-sm">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${err.message})</div>`;
            }
        }
    </script>
</body>
</html>