<!DOCTYPE html>
<html class="light" lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Lotto Lab - 번호별 출현 통계 (Supabase AI)</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="js/layout.js"></script>

    <script>
        // ✅ Supabase 설정
        const SUPABASE_URL = 'https://dkcflmyoscudawleglzb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrY2ZsbXlvc2N1ZGF3bGVnbHpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NDQ4OTAsImV4cCI6MjA4MzEyMDg5MH0.haAvbpScvMJv1uqH_tk-0fUlJNCpHnlWBtYzX6YFweo';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allData = [];
        let currentRange = 73;
        let sortByMissCount = true;

        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "active-green": "#E6FFED",
                        "active-text": "#16A34A",
                        "primary-blue": "#4F6AFF",
                    },
                    fontFamily: {
                        "sans": ["Pretendard", "Inter", "system-ui", "sans-serif"],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow-blue': '0 4px 14px 0 rgba(59, 130, 246, 0.3)',
                        'glow-red': '0 4px 14px 0 rgba(239, 68, 68, 0.35)',
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined.filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Table Styling */
        .stats-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 11px; }
        .stats-table th { 
            background: #ffffff; 
            padding: 12px 4px; 
            text-align: center; 
            border-bottom: 2px solid #f1f5f9; 
            font-weight: 700; 
            color: #475569;
            position: sticky; 
            top: 0; 
            z-index: 20; 
            font-size: 11px;
        }
        .stats-table td { 
            padding: 6px 2px; 
            text-align: center; 
            border-bottom: 1px solid #f8fafc; 
            background: white; 
            font-size: 10px; 
            height: 34px;
            vertical-align: middle;
            transition: background 0.1s;
        }
        .stats-table tr:hover td { background: #f8fafc; }
        
        .stats-table .round-col { 
            position: sticky; 
            left: 0; 
            background: #ffffff; 
            z-index: 15; 
            font-weight: 600; 
            color: #64748b;
            min-width: 70px; 
            border-right: 1px solid #f1f5f9;
        }
        .stats-table tr:hover .round-col { background: #f8fafc; }
        .stats-table th.round-col { z-index: 30; border-bottom: 2px solid #f1f5f9; }

        /* Marker Base */
        .marker {
            width: 22px; 
            height: 22px; 
            border-radius: 50%; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700;
            font-size: 10px;
            transition: all 0.2s ease;
        }
        
        .marker-hit { 
            background: linear-gradient(135deg, #0ea5e9 0%, #10b981 100%); 
            color: white; 
            box-shadow: 0 3px 8px rgba(14, 165, 233, 0.3);
        }
        
        .marker-carry { 
            background: linear-gradient(135deg, #f43f5e 0%, #f97316 100%); 
            color: white;
            box-shadow: 0 3px 8px rgba(244, 63, 94, 0.4);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .cell-miss { 
            color: #cbd5e1; 
            font-weight: 500;
        }
        .miss-high { color: #f43f5e; font-weight: 700; } 

        .number-header { 
            color: #64748b; 
            min-width: 34px; 
            font-size: 11px; 
        }
        
        .count-row td { 
            background: #fffbeb !important; 
            border-top: 2px solid #fcd34d;
            border-bottom: 2px solid #fcd34d;
            font-weight: 700; 
            color: #b45309; 
            padding: 10px 0;
        }
        .count-row .round-col { 
            background: #fffbeb !important; 
            color: #b45309;
            border-top: 2px solid #fcd34d;
            border-bottom: 2px solid #fcd34d;
        }

        /* Chart Styling */
        .chart-container { display: grid; grid-template-columns: repeat(45, 1fr); gap: 6px; align-items: end; padding: 0 4px; }
        
        .chart-bar-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; }
        
        .bar-fill { 
            width: 100%; 
            border-radius: 6px 6px 0 0; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .chart-bar-wrapper:hover .bar-fill { 
            filter: brightness(1.1) contrast(1.1);
            transform: scaleY(1.05); 
        }
        
        /* Custom Range Slider (carryover.html 스타일) */
        input[type="range"] { 
            -webkit-appearance: none; appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #E5E7EB; outline: none; cursor: pointer; 
            background-image: linear-gradient(#3B82F6, #3B82F6); background-size: var(--value-percent, 0%) 100%; background-repeat: no-repeat; 
        }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #3B82F6; cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.1s; border: 2px solid white; 
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); background: #2563EB; }
        
        .ai-section { 
            background: white;
            border: 1px solid #e9d5ff;
            background-image: radial-gradient(circle at 10% 10%, #faf5ff 0%, #ffffff 50%);
        }
    </style>
</head>
<body class="bg-[#F3F4F6] font-sans antialiased text-gray-800">
    <div class="flex flex-col h-screen w-full">
        
        <div id="gnb-container"></div>
        
        <div class="flex flex-1 overflow-hidden">
            <aside class="w-56 bg-white border-r border-gray-200 overflow-y-auto custom-scrollbar flex-shrink-0" id="lnb-container">
            </aside>
            
            <main class="flex-1 overflow-hidden p-8">
                <div class="h-full flex flex-col space-y-5 max-w-[1600px] mx-auto">
                    <div class="flex items-end justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 mb-1">번호별 출현 통계</h1>
                            <p class="text-sm text-gray-500">각 회차별 당첨/낙첨 현황을 시각적으로 분석합니다.</p>
                        </div>
                    </div>

                    <div class="ai-section rounded-2xl p-6 shadow-soft">
                        <div class="flex items-center justify-start gap-4 mb-5">
                            <div class="flex items-center gap-2">
                                <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                                    <span class="material-symbols-outlined text-2xl filled">psychology</span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900">AI 번호별 분석</h3>
                            </div>
                            <button onclick="refreshAIAnalysis()" class="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700">
                                <span class="material-symbols-outlined text-lg">refresh</span>새로고침
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="aiAnalysisContent">
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="material-symbols-outlined text-blue-500">insights</span>
                                    <h4 class="font-bold text-gray-800 text-sm">패턴 인사이트</h4>
                                </div>
                                <p class="text-xs text-gray-600 leading-relaxed" id="aiPatternText">
                                    <span class="flex items-center gap-2 text-gray-500"><span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>AI 분석 중...</span>
                                </p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="material-symbols-outlined text-green-500">trending_up</span>
                                    <h4 class="font-bold text-gray-800 text-sm">출현 추세</h4>
                                </div>
                                <p class="text-xs text-gray-600 leading-relaxed" id="aiTrendText">
                                    <span class="flex items-center gap-2 text-gray-500"><span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>AI 분석 중...</span>
                                </p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="material-symbols-outlined text-purple-500">lightbulb</span>
                                    <h4 class="font-bold text-gray-800 text-sm">전략 제안</h4>
                                </div>
                                <p class="text-xs text-gray-600 leading-relaxed" id="aiStrategyText">
                                    <span class="flex items-center gap-2 text-gray-500"><span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>AI 분석 중...</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-soft border border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-gray-400">bar_chart</span>
                                <h3 class="text-sm font-bold text-gray-700">번호별 당첨율 분포</h3>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-3 rounded-full bg-red-500 shadow-sm"></div>
                                    <span class="text-xs text-gray-500 font-medium">평균 초과 (Red)</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <div class="w-3 h-3 rounded-full bg-blue-500 shadow-sm"></div>
                                    <span class="text-xs text-gray-500 font-medium">평균 이하 (Blue)</span>
                                </div>
                                <span class="text-xs font-bold px-2 py-1 bg-gray-100 text-gray-800 rounded text-center ml-2" id="chartRangeLegend">100회 통계</span>
                            </div>
                        </div>
                        <div id="chart" class="chart-container w-full" style="height: 180px;"></div>
                        <div class="grid grid-cols-45 gap-1 mt-2 px-[4px]">
                            </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="bg-white rounded-2xl p-5 shadow-soft border border-gray-100 flex flex-col justify-center">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-bold text-gray-700">분석 회차 범위</h3>
                                <span class="text-sm font-bold text-white bg-black px-3 py-1 rounded-full shadow-md shadow-gray-200" id="rangeLabel">최근 73회차</span>
                            </div>
                            <div class="relative px-1 mb-4">
                                <input type="range" id="rangeSlider" min="10" max="1203" value="73" step="1" class="w-full" oninput="updateRange(this.value)">
                            </div>
                            <div class="flex gap-1.5 flex-wrap justify-center">
                                <button onclick="setRange(10)" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors" id="btn10">10회</button>
                                <button onclick="setRange(30)" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors" id="btn30">30회</button>
                                <button onclick="setRange(50)" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors" id="btn50">50회</button>
                                <button onclick="setRange(100)" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors" id="btn100">100회</button>
                                <button onclick="setRange(1203)" class="px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors" id="btn1203">전체</button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl p-5 shadow-soft border border-gray-100 flex flex-col justify-between">
                             <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-bold text-gray-700">범례 및 정렬</h3>
                            </div>
                            <div class="flex items-center gap-4 mb-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded-full bg-gradient-to-br from-[#0ea5e9] to-[#10b981] shadow-glow-blue"></div>
                                    <span class="text-xs text-gray-600 font-medium">당첨 (Emerald Blue)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded-full bg-gradient-to-br from-[#f43f5e] to-[#f97316] shadow-glow-red border border-white"></div>
                                    <span class="text-xs text-gray-600 font-medium">연속당첨 (Bright Red)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-400 font-medium">숫자</span>
                                    <span class="text-xs text-gray-600 font-medium">미당첨 기간</span>
                                </div>
                            </div>
                            <button onclick="toggleSort()" class="w-full py-2.5 text-xs font-bold rounded-xl bg-gray-900 text-white hover:bg-gray-800 flex items-center justify-center gap-2 transition-all shadow-lg shadow-gray-200">
                                <span class="material-symbols-outlined text-sm">swap_vert</span>
                                <span id="sortButtonText">미당첨 짧은 순 정렬 중</span>
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 bg-white rounded-2xl border border-gray-200 shadow-soft overflow-hidden flex flex-col">
                        <div class="overflow-auto custom-scrollbar flex-1 relative">
                            <table class="stats-table" id="statsTable">
                                <thead><tr><th class="round-col shadow-sm">회차</th></tr></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", async function() {
            try {
                // Supabase에서 데이터 로드
                const { data, error } = await supabaseClient
                    .from('lotto_draws') 
                    .select('*')
                    .order('round', { ascending: false })
                    .range(0, 5000); 

                if (error) throw error;
                
                allData = data;
                
                // UI 초기화
                const totalCount = allData.length;
                const rangeSlider = document.getElementById('rangeSlider');
                rangeSlider.max = totalCount;
                document.getElementById('btn1203').setAttribute('onclick', `setRange(${totalCount})`);
                
                updateRange(currentRange);
            } catch (err) {
                console.error('데이터 로드 실패:', err);
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="46" class="p-10 text-center text-red-500">데이터 로드 실패<br>${err.message}</td></tr>`;
            }
        });

        // AI 응답 포맷팅 유틸리티
        function formatAIResponse(text) {
            if (!text) return "";
            return text
                .replace(/{{number:(.*?)}}/g, '<span class="text-red-600 bg-red-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{up:(.*?)}}/g, '<span class="text-green-600 bg-green-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{down:(.*?)}}/g, '<span class="text-orange-600 bg-orange-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{warn:(.*?)}}/g, '<span class="text-yellow-600 bg-yellow-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{good:(.*?)}}/g, '<span class="text-blue-600 bg-blue-50 font-bold px-1 rounded">$1</span>')
                .replace(/{{range:(.*?)}}/g, '<span class="text-purple-600 bg-purple-50 font-bold px-1 rounded">$1</span>');
        }

        async function refreshAIAnalysis() {
            // 로딩 표시
            document.getElementById('aiPatternText').innerHTML = `<span class="flex items-center gap-2 text-gray-500"><span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>분석 중...</span>`;
            document.getElementById('aiTrendText').innerHTML = `<span class="flex items-center gap-2 text-gray-500"><span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>분석 중...</span>`;
            document.getElementById('aiStrategyText').innerHTML = `<span class="flex items-center gap-2 text-gray-500"><span class="material-symbols-outlined animate-spin text-sm">progress_activity</span>분석 중...</span>`;

            const displayData = allData.slice(0, currentRange);
            const hitCounts = new Array(46).fill(0);
            
            displayData.forEach(draw => {
                draw.numbers.forEach(num => { hitCounts[num]++ });
            });
            
            const hitValues = hitCounts.slice(1);
            const avgHit = (hitValues.reduce((a,b)=>a+b,0)/45).toFixed(1);
            const maxHitNum = hitCounts.indexOf(Math.max(...hitValues));
            
            // AI Context 요약
            const summary = `최근 ${currentRange}회 분석: 최다출현번호 ${maxHitNum}번(${hitCounts[maxHitNum]}회), 평균출현 ${avgHit}회.`;

            try {
                const { data: analysis, error } = await supabaseClient.functions.invoke('analyze-lotto', {
                    body: { currentRange, recentDraws: summary, type: '번호별 통계' }
                });
                
                if (error) throw error;
                
                // AI 응답 적용
                document.getElementById('aiPatternText').innerHTML = formatAIResponse(analysis.pattern);
                document.getElementById('aiTrendText').innerHTML = formatAIResponse(analysis.trend);
                document.getElementById('aiStrategyText').innerHTML = formatAIResponse(analysis.recommendation);

            } catch (err) {
                console.error("AI 분석 실패:", err);
                const errorMsg = "AI 분석을 불러올 수 없습니다.";
                document.getElementById('aiPatternText').textContent = errorMsg;
                document.getElementById('aiTrendText').textContent = errorMsg;
                document.getElementById('aiStrategyText').textContent = errorMsg;
            }
        }
        
        function renderChart(){
            const displayData=allData.slice(0,currentRange);
            const hitCounts=new Array(46).fill(0);
            
            displayData.forEach(draw=>{
                draw.numbers.forEach(num=>{hitCounts[num]++});
            });
            
            const chartData=[];
            for(let i=1;i<=45;i++){
                chartData.push({num:i,count:hitCounts[i],rate:(hitCounts[i]/currentRange*100).toFixed(1)});
            }
            
            const totalHits = chartData.reduce((sum, item) => sum + item.count, 0);
            const avgHit = totalHits / 45;
            
            const maxCount=Math.max(...chartData.map(d=>d.count));
            const chart=document.getElementById('chart');
            chart.innerHTML='';
            
            chartData.forEach(d=>{
                const barHeight=(d.count/maxCount*100);
                
                let bgStyle;
                if (d.count > avgHit) {
                    // Above Average: Red
                    bgStyle = "background: #EF4444;";
                } else {
                    // Below Average: Blue
                    bgStyle = "background: #3B82F6;";
                }

                const wrapper=document.createElement('div');
                wrapper.className='chart-bar-wrapper group relative';
                wrapper.innerHTML=`
                    <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-[10px] py-0.5 px-1.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10 pointer-events-none">${d.count}회</div>
                    <div class="bar-fill" style="height:${Math.max(barHeight, 5)}%; ${bgStyle}"></div>
                    <div class="text-[9px] font-medium text-gray-500 mt-1.5 text-center w-full">${d.num}</div>
                `;
                chart.appendChild(wrapper);
            });
        }
        
        function renderTable(){
            const displayData=allData.slice(0,currentRange);
            const hitCounts=new Array(46).fill(0);
            
            displayData.forEach(draw=>{
                draw.numbers.forEach(num=>{hitCounts[num]++});
            });
            
            const currentMiss={};
            const missHistory={}; 
            const fullReversedData=[...allData].reverse();
            
            for(let i=1;i<=45;i++){currentMiss[i]=0}
            
            fullReversedData.forEach(draw=>{
                draw.numbers.forEach(num=>{currentMiss[num]=0});
                for(let i=1;i<=45;i++){
                    if(!draw.numbers.includes(i)){currentMiss[i]++}
                }
                missHistory[draw.round] = {...currentMiss};
            });
            
            let numberOrder=Array.from({length:45},(e,i)=>i+1);
            if(sortByMissCount){
                const latestMiss = missHistory[displayData[0].round];
                numberOrder.sort((a,b)=>latestMiss[a]-latestMiss[b]);
            }
            
            const thead=document.querySelector("#statsTable thead tr");
            thead.innerHTML='<th class="round-col">회차</th>';
            numberOrder.forEach(num=>{
                const th=document.createElement("th");
                th.className="number-header";
                th.textContent=num;
                thead.appendChild(th);
            });
            
            const rowData=[];
            
            displayData.forEach((draw, index)=>{
                const cells={};
                const prevDraw = allData[index + 1];
                const prevNumbers = prevDraw ? prevDraw.numbers : [];

                numberOrder.forEach(num=>{
                    if(draw.numbers.includes(num)){
                        if(prevNumbers.includes(num)){
                            cells[num]={type:'carry'};
                        } else {
                            cells[num]={type:'hit'};
                        }
                    } else {
                        cells[num]={type:'miss',count:missHistory[draw.round][num]};
                    }
                });
                rowData.push({round:draw.round,cells:cells});
            });
            
            const tbody=document.getElementById("tableBody");
            let html='<tr class="count-row"><td class="round-col">당첨횟수</td>';
            numberOrder.forEach(num=>{html+=`<td>${hitCounts[num]}</td>`});
            html+='</tr>';
            
            rowData.forEach(row=>{
                html+=`<tr><td class="round-col">${row.round}회</td>`;
                numberOrder.forEach(num=>{
                    const cell=row.cells[num];
                    if(cell.type==='hit'){
                        html+=`<td><div class="flex justify-center items-center h-full"><span class="marker marker-hit"></span></div></td>`;
                    }else if(cell.type==='carry'){
                        html+=`<td><div class="flex justify-center items-center h-full"><span class="marker marker-carry"></span></div></td>`;
                    }else{
                        const missClass = cell.count >= 10 ? 'miss-high' : 'cell-miss';
                        html+=`<td><span class="${missClass}">${cell.count}</span></td>`;
                    }
                });
                html+='</tr>';
            });
            
            tbody.innerHTML=html;
        }
        
        function updateRange(e){
            currentRange=parseInt(e);
            document.getElementById("rangeLabel").textContent=allData.length==e?"전체 회차":"최근 "+e+"회차";
            document.getElementById("chartRangeLegend").textContent = e + "회 통계";
            
            updateSliderBackground(e);
            updateRangeButtons(e);
            renderTable();
            renderChart();
            refreshAIAnalysis();
        }
        
        function setRange(e){
            document.getElementById("rangeSlider").value=e;
            updateRange(e);
        }
        
        function updateSliderBackground(value) {
            const total = allData.length || 1203;
            const slider = document.getElementById('rangeSlider');
            if (slider) {
                const percent = ((value - 10) / (total - 10)) * 100;
                slider.style.setProperty('--value-percent', percent + '%');
            }
        }

        function updateRangeButtons(e){
            const maxVal = allData.length;
            const buttons = {10: 'btn10', 30: 'btn30', 50: 'btn50', 100: 'btn100', 1203: 'btn1203'};
            
            Object.keys(buttons).forEach(key => {
                const btn = document.getElementById(buttons[key]);
                if (btn) {
                    const targetValue = key === '1203' ? maxVal : parseInt(key);
                    if(targetValue === parseInt(e)) {
                        btn.className = "px-3 py-1.5 text-sm font-medium bg-blue-500 text-white rounded-lg transition-colors";
                    } else {
                        btn.className = "px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors";
                    }
                }
            });
        }
        
        function toggleSort(){
            sortByMissCount=!sortByMissCount;
            const btn=document.querySelector('button[onclick="toggleSort()"]');
            const btnText=document.getElementById("sortButtonText");
            if(sortByMissCount){
                btn.className='w-full py-2.5 text-xs font-bold rounded-xl bg-gray-900 text-white hover:bg-gray-800 flex items-center justify-center gap-2 transition-all shadow-lg shadow-gray-200';
                btnText.textContent='미당첨 짧은 순 정렬 중';
            }else{
                btn.className='w-full py-2.5 text-xs font-bold rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 flex items-center justify-center gap-2 transition-all shadow-sm';
                btnText.textContent='번호순 정렬';
            }
            renderTable();
        }
    </script>
</body>
</html>